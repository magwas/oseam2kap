#!/bin/bash
set -x
. $1

if [ "x$osmfile" = "x" ]
then
    wget http://jxapi.openstreetmap.org/xapi/api/0.6/map?bbox=$minlon,$minlat,$maxlon,$maxlat -O tmp/${outname}.osm
fi
osmfile=${osmfile:-../../tmp/${outname}.osm}

for zz in $z
do

    cat $osmfile | grep "user="| sed 's/^.*user=\"//;s/\".*//' |sort |uniq|awk '{printf("%s, ",$1);}' >tmp/${outname}_contributors
    grep '<tag k="source"' $osmfile |sed 's/^.* v="//;s/".*//'|sort|uniq|awk '{printf("%s, ",$1);}' >tmp/${outname}_sources
     cat $osmfile | grep "timestamp="| sed 's/^.*timestamp=\"//;s/\".*//' |sort|tail -1 >tmp/${outname}_timestamp


    #xsltproc --stringparam osmfile $osmfile --stringparam minlon $minlon --stringparam maxlon $maxlon --stringparam minlat $minlat --stringparam maxlat $maxlat -o tmp/${outname}_$zz.svg ./osr/xslt/osmarender.xsl osr/stylesheets/composite-z$zz.xml
    #or/p is screwed up copyrightwise
    perl osr/orp/orp.pl -r osr/stylesheets/composite-z$zz.xml -b $minlat,$minlon,$maxlat,$maxlon -o tmp/${outname}_$zz.svg $osmfile
    d=`python -c "print int($dpi*(2**$zz))"`
    inkscape tmp/${outname}_$zz.svg -d $d --export-png=tmp/${outname}_$zz.png

    echo '<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><GroundOverlay>' >tmp/${outname}_$zz.kml
    echo "<name>Balaton</name><Icon><href>${outname}_$zz.png</href></Icon>" >>tmp/${outname}_$zz.kml
    echo "<LatLonBox><north>$maxlat</north><south>$minlat</south>" >>tmp/${outname}_$zz.kml
    echo "<east>$maxlon</east><west>$minlon</west><rotation>0</rotation>" >>tmp/${outname}_$zz.kml
    echo "</LatLonBox></GroundOverlay></kml>" >>tmp/${outname}_$zz.kml

    ./imgkap tmp/${outname}_$zz.kml ${outname}_$zz.kap

done


